<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>
<script type="module">
  const jsonUrl = "./test-data.json";
  // const jsonUrl = "https://uscms-software-and-computing.github.io/OpenProject_data/data/all_results.json";

  const DateTime = luxon.DateTime;

  async function getLiveData() {
    try {
      const response = await fetch(jsonUrl, { mode: 'cors'});
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const jsonData = await response.json();
      return processData(jsonData);
    } catch (error) {
      console.error("Error fetching or processing data:", error);
      // Handle the error here, maybe show an error message to the user
    }
  }
  function processData(data) {
    const workPackages = data._embedded?.elements || []; // Use optional chaining

    const workPackageById = workPackages.reduce((map, item) => {
      map[item.id] = item;
      return map;
    }, {});

    const parentId = (parentHref) => Number((parentHref?.href?.match(/.*\/(\d+)/) || [])[1] || 0);

    function getChildren(childrenList) {
      let children = [];
      childrenList.forEach(child => {
        const regex = /.*\/(\d+)/gm;
        const match = regex.exec(child?.href);
        const childId = Number(match[1]);
        children.push(workPackageById[childId]);
      })
      return children.map(item => ({
        id: item.id,
        name: item.subject,
        project: item._links.project.title,
        parent: parentId(item._links?.parent?.href),
        children: item._links.children ? getChildren(item._links.children) : undefined,
        startDate: item.startDate ? formatDate(item.startDate) : formatDate(item.date),
        endDate: item.dueDate ? formatDate(item.dueDate) : formatDate(item.date),
        progress: item.percentageDone
      }));
    }

    const formatDate = (date) => DateTime.fromISO(date); // Remove unused arguments

    return workPackages.map(item => ({
      id: item.id,
      name: item.subject,
      project: item._links.project.title,
      parent: parentId(item._links?.parent?.href),
      children: item._links.children ? getChildren(item._links.children) : undefined,
      startDate: item.startDate ? formatDate(item.startDate) : formatDate(item.date),
      endDate: item.dueDate ? formatDate(item.dueDate) : formatDate(item.date),
      progress: item.percentageDone
    }))

  }


  const tableColumns = [
    {title: "Name", field:"name"},
    {title: "ID", field: "id"},
    {title: "Project", field: "project"},
    {title: "Start Date", field: "startDate", sorter: "date"},
    {title: "End Data", field: "endDate", sorter: "date"},
    {title: "Progress", field: "progress"}
  ];

  getLiveData().then(data => {
    return data;
  }).then(tableData => {
    let table = new Tabulator("#example-table", {
      data: tableData,
      dataTree: true,
      dataTreeChildField: "children",
      dataTreeSort:false,
      columns: tableColumns,
      groupBy:["project"],
      initialSort:[
        {column:"endDate", dir:"asc"},
        {column: "project", dir:"asc"},
      ]
    });
  });

</script>

<div id="example-table"></div>
</body>
</html>
